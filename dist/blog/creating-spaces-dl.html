<!DOCTYPE html>
<html lang="en">

<head>
 <meta charset="UTF-8">
 <meta http-equiv="X-UA-Compatible" content="IE=edge">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>David Uzondu</title>
 <style>
  @import url('https://fonts.googleapis.com/css2?family=Spline+Sans+Mono:ital,wght@0,300..700;1,300..700&family=Spline+Sans:wght@300..700&display=swap');

  * {
   padding: 0;
   box-sizing: border-box;
  }


  :root {
   --gray: rgb(48, 55, 58);
   --code: rgb(197, 51, 6);
  }

  .post-item {
   display: grid;
   grid-template-columns: 30% 70%;
   gap: 5px;
   margin-bottom: 20px;
  }

  .post-item span {
   display: flex;
   align-items: center;
  }


  h1 {
   margin: 30px 0px 20px 0px;
  }

  .post-date {
   font-size: 1em;
  }

  body {
   font-family: "Spline Sans", sans-serif;
   background-color: rgba(236, 242, 248, 0.543);
   color: var(--gray);
   font-weight: 300;
   width: 40%;
   padding: 20px;
   overflow-wrap: break-word;
   margin: 0 auto;
  }

  nav {
   display: flex;
   font-size: 1.1em;
   gap: 10px;
  }

  @media screen and (max-width: 1000px) {
   body {
    width: 100%;
    margin: 0px;
   }

   .post-item {
    grid-template-columns: 1fr;
   }
  }

  li {
   list-style: circle;
   margin: 0;
   padding: 0;
  }

  li::marker {
   margin: 0;
   padding: 0;
  }

  h2,
  h3,
  h4 {
   font-weight: 400;
   margin-bottom: 10px;
   color: rgb(46, 120, 173);
  }

  h2 {
   margin-top: 40px;
  }

  h1 {
   color: rgb(17, 80, 125);
   font-weight: 400;
   font-size: 2.5em;
  }

  pre {
   overflow: auto;
   max-height: 70vh;
   border-radius: 5px;
   padding-left: 10px;
   padding-top: 10px;
   padding-bottom: 10px;
   font-size: 15px;
  }

  p {
   font-size: 18px;
   line-height: 30px;
  }

  code {
   font-family: "Spline Sans Mono", monospace;
   font-optical-sizing: auto;
  }
  
  p code {
   font-size: 15px;
   background-color: white;
   padding: 3px;
   border-radius: 4px;
   border: 1px solid #d4c9c9;
   color: var(--code);
   line-height: 20px;
   margin-top: 10px;
   margin-bottom: 10px;
  }

  a {
   color: rgb(3, 112, 189);
  }

  a:hover {
   background-color: rgb(0 122 208);
   color: white
  }

  img:has(+ em) {
   border: 0.1px dotted rgb(0 122 208);
   width: 100%;
   max-height: 50vh;
   object-fit: contain;
  }

  img+em {
   margin-top: -5px;
   display: flex;
   font-size: 14px;
   align-items: center;
   justify-content: center;
  }

  .gh-page {
   font-size: 14px;
   text-align: center;
  }

  .footnotes *{
   font-size: 15px;
  }
 </style>

</head>

<body>
 
 <nav>
    <a href='/'>Home</a>
    <a href='/blog'>Blog</a>
</nav>

 <main>
<article>
  <h1>Creating a Twitter Spaces Downloader Using Node.js and FFmpeg</h1>
  <span class="post-date">
    
      28 June 2024
    
  </span>
  <div>
    <p><img src="https://i.imgur.com/j4gD4fw.jpg" alt="virgin api consumer vs chad independent scraper"> <em>A meme I found on 4chan</em></p>
<p>Hello, My name is David Uzondu and I am a final year Computer Science student at Bayero University Kano. I was recently approved for the back-end track on the HNG internship program.</p>
<p>One reason I am excited to participate in the <a href="https://hng.tech/internship">HNG internship program</a> is to gain hands-on experience and deepen my skills in back-end development. This opportunity will work on real-world projects, learn best practices, and collaborate with industry professionals. I also signed up for <a href="https://hng.tech/premium">HNG Premium</a> which will give me access to exclusive opportunities like certificates, reference letters, and the latest job openings.</p>
<p>A few weeks ago, I wanted to listen to a Twitter Space conversation but had network issues. I noticed the space was recorded, so I bookmarked the link to return when my connection was stable.</p>
<p>The next day, I tried to listen again, but the Twitter app wouldn’t load the space, which frustrated me. Since Twitter doesn’t allow downloading recorded spaces for later, I decided to use <code>yt-dlp</code>—a command-line tool that downloads media from sites like YouTube, Vimeo, and Twitter. However, there was a bug in the version of <code>yt-dlp</code> installed on my machine that caused the program to crash whenever I tried to download a space.</p>
<p>So I figured, why not create my own space downloader tool? It would be great practice for Node.js and TypeScript.</p>
<h2>Reverse-engineering the Twitter Internal API</h2>
<p>On my Chrome desktop, I loaded the Twitter Space page while listening for the network requests in the DevTools. When you open a recorded Twitter Space link in Chrome or any other browser, here's what happens (assuming you are signed in):</p>
<p>Twitter loads a modal on the <code>/peek</code> route. This modal shows important information about the space, like the host and speakers, and provides a big blue &quot;Play recording&quot; button.</p>
<p>When the button is clicked, a GET request is sent to <code>https://x.com/i/api/graphql/SL4eyLXdr1zWZVpXRhxZ4Q?variables=&lt;variables&gt;&amp;features=&lt;features&gt;</code>, where <code>variables</code> and <code>features</code> are query string parameters. <code>variables</code> is encoded with the following key-value pair:</p>
<pre tabindex="0" style="color:#ebdbb2;background-color:#282828;"><code><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#fb4934">&#34;id&#34;</span>: <span style="color:#b8bb26">&#34;&lt;valid_twitter_spaces_id&gt;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#fb4934">&#34;isMetatagsQuery&#34;</span>: <span style="color:#fe8019">true</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#fb4934">&#34;withReplays&#34;</span>: <span style="color:#fe8019">true</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#fb4934">&#34;withListeners&#34;</span>: <span style="color:#fe8019">true</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>And <code>features</code> is encoded with the following:</p>
<pre tabindex="0" style="color:#ebdbb2;background-color:#282828;"><code><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#fb4934">&#34;rweb_tipjar_consumption_enabled&#34;</span>: <span style="color:#fe8019">true</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#fb4934">&#34;responsive_web_graphql_exclude_directive_enabled&#34;</span>: <span style="color:#fe8019">true</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#fb4934">&#34;verified_phone_label_enabled&#34;</span>: <span style="color:#fe8019">false</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#fb4934">&#34;creator_subscriptions_tweet_preview_api_enabled&#34;</span>: <span style="color:#fe8019">true</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#fb4934">&#34;responsive_web_graphql_timeline_navigation_enabled&#34;</span>: <span style="color:#fe8019">true</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#fb4934">&#34;responsive_web_graphql_skip_user_profile_image_extensions_enabled&#34;</span>: <span style="color:#fe8019">false</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#fb4934">&#34;communities_web_enable_tweet_community_results_fetch&#34;</span>: <span style="color:#fe8019">true</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#fb4934">&#34;c9s_tweet_anatomy_moderator_badge_enabled&#34;</span>: <span style="color:#fe8019">true</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#fb4934">&#34;articles_preview_enabled&#34;</span>: <span style="color:#fe8019">true</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#fb4934">&#34;tweetypie_unmention_optimization_enabled&#34;</span>: <span style="color:#fe8019">true</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#fb4934">&#34;responsive_web_edit_tweet_api_enabled&#34;</span>: <span style="color:#fe8019">true</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#fb4934">&#34;graphql_is_translatable_rweb_tweet_is_translatable_enabled&#34;</span>: <span style="color:#fe8019">true</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#fb4934">&#34;view_counts_everywhere_api_enabled&#34;</span>: <span style="color:#fe8019">true</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#fb4934">&#34;longform_notetweets_consumption_enabled&#34;</span>: <span style="color:#fe8019">true</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#fb4934">&#34;responsive_web_twitter_article_tweet_consumption_enabled&#34;</span>: <span style="color:#fe8019">true</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#fb4934">&#34;tweet_awards_web_tipping_enabled&#34;</span>: <span style="color:#fe8019">false</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#fb4934">&#34;creator_subscriptions_quote_tweet_preview_enabled&#34;</span>: <span style="color:#fe8019">false</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#fb4934">&#34;freedom_of_speech_not_reach_fetch_enabled&#34;</span>: <span style="color:#fe8019">true</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#fb4934">&#34;standardized_nudges_misinfo&#34;</span>: <span style="color:#fe8019">true</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#fb4934">&#34;tweet_with_visibility_results_prefer_gql_limited_actions_policy_enabled&#34;</span>: <span style="color:#fe8019">true</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#fb4934">&#34;rweb_video_timestamps_enabled&#34;</span>: <span style="color:#fe8019">true</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#fb4934">&#34;longform_notetweets_rich_text_read_enabled&#34;</span>: <span style="color:#fe8019">true</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#fb4934">&#34;longform_notetweets_inline_media_enabled&#34;</span>: <span style="color:#fe8019">true</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#fb4934">&#34;responsive_web_enhance_cards_enabled&#34;</span>: <span style="color:#fe8019">false</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#fb4934">&#34;spaces_2022_h2_clipping&#34;</span>: <span style="color:#fe8019">false</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#fb4934">&#34;spaces_2022_h2_spaces_communities&#34;</span>: <span style="color:#fe8019">false</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>If the request was successful, there is JSON response containing data about the Space. This JSON response contains a <code>media_key</code> under <code>data.audioSpace.metadata</code>. That <code>media_key</code>is important because it basically allows Twitter to access the M3U8 file.</p>
<p>If you're wondering what the heck an M3U8 file is, it is basically a plain text file that stores the URL paths of streaming audio or video and media track information. For example, one M3U8 file may give you references to online files for an YouTube video. I stole that definition from Google, you're welcome.</p>
<p>Okay, so now that the <code>media_key</code> is known, Twitter makes another GET request to <code>https://x.com/i/api/1.1/live_video_stream/status/&lt;media_key&gt;</code>, replacing <code>&lt;media_key&gt;</code> with the actual media key retrieved earlier. This returns another JSON response that looks similar to this:</p>
<pre tabindex="0" style="color:#ebdbb2;background-color:#282828;"><code><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#fb4934">&#34;source&#34;</span> : {
</span></span><span style="display:flex;"><span>    <span style="color:#fb4934">&#34;location&#34;</span> : <span style="color:#b8bb26">&#34;https://example.com/audio/playlist.m3u8&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#fb4934">&#34;noRedirectPlaybackUrl&#34;</span> : <span style="color:#b8bb26">&#34;https://example.com/audio/playlist.m3u8&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#fb4934">&#34;status&#34;</span> : <span style="color:#b8bb26">&#34;LIVE_PUBLIC&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#fb4934">&#34;streamType&#34;</span> : <span style="color:#b8bb26">&#34;HLS&#34;</span>
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  <span style="color:#fb4934">&#34;sessionId&#34;</span> : <span style="color:#b8bb26">&#34;1234567890123456789&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#fb4934">&#34;chatToken&#34;</span> : <span style="color:#b8bb26">&#34;dummyChatToken&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#fb4934">&#34;lifecycleToken&#34;</span> : <span style="color:#b8bb26">&#34;dummylifecycleToken&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#fb4934">&#34;shareUrl&#34;</span> : <span style="color:#b8bb26">&#34;https://twitter.com/i/broadcasts/12345&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>The most interesting thing to take note of is <code>source.location</code>, because it holds the actual URL to the hosted M3U8 file. From here things become a bit easier. You can copy this URL and run the following:</p>
<pre tabindex="0" style="color:#ebdbb2;background-color:#282828;"><code><span style="display:flex;"><span>yt-dlp &lt;m3u8_url&gt;
</span></span></code></pre><h2>Automating the entire thing with a CLI</h2>
<p>What do you do when you can't access a Twitter Space without logging in and the official Twitter API costs nearly double your country's minimum wage? Naturally, you turn to web scraping. I started the project and created a <code>Downloader</code> class that will be instantiated later by the Command Line Interface (CLI).</p>
<pre tabindex="0" style="color:#ebdbb2;background-color:#282828;"><code><span style="display:flex;"><span><span style="color:#fe8019">export</span> <span style="color:#fe8019">class</span> Downloader <span style="color:#fe8019">implements</span> DownloaderInterface {
</span></span><span style="display:flex;"><span>  <span style="color:#fe8019">private</span> username: <span style="color:#fabd2f">string</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#fe8019">private</span> password: <span style="color:#fabd2f">string</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#fe8019">private</span> options<span style="color:#fe8019">!:</span> DownloaderOptions;
</span></span><span style="display:flex;"><span>  <span style="color:#fe8019">private</span> headers: <span style="color:#fabd2f">TaskHeaders</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#fe8019">private</span> audioSpaceData<span style="color:#fe8019">!:</span> Record&lt;<span style="color:#fb4934">string</span>, <span style="color:#b8bb26;font-weight:bold">any</span>&gt;;
</span></span><span style="display:flex;"><span>  <span style="color:#fe8019">private</span> mediaKey<span style="color:#fe8019">!:</span> <span style="color:#fabd2f">string</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#fe8019">private</span> id: <span style="color:#fabd2f">string</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#fe8019">private</span> isLoggedIn: <span style="color:#fabd2f">boolean</span> <span style="color:#fe8019">=</span> <span style="color:#fe8019">false</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#fe8019">private</span> $: <span style="color:#fabd2f">any</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#fe8019">private</span> playlist<span style="color:#fe8019">!:</span> <span style="color:#fabd2f">string</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#fe8019">private</span> playlistUrl<span style="color:#fe8019">!:</span> <span style="color:#fabd2f">string</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#fe8019">private</span> chunkBaseUrl<span style="color:#fe8019">!:</span> <span style="color:#fabd2f">string</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#fe8019">private</span> downloadChunksCount: <span style="color:#fabd2f">number</span> <span style="color:#fe8019">=</span> <span style="color:#d3869b">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#fe8019">private</span> storagePath;
</span></span><span style="display:flex;"><span>  <span style="color:#fe8019">private</span> chunksUrls<span style="color:#fe8019">!:</span> <span style="color:#fabd2f">string</span>[];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#fe8019">constructor</span>(options: <span style="color:#fabd2f">DownloaderOptions</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">this</span>.options <span style="color:#fe8019">=</span> options;
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">this</span>.username <span style="color:#fe8019">=</span> options.username;
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">this</span>.password <span style="color:#fe8019">=</span> options.password;
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">this</span>.id <span style="color:#fe8019">=</span> options.id;
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">this</span>.storagePath <span style="color:#fe8019">=</span> path.resolve(<span style="color:#b8bb26">`./task-</span><span style="color:#b8bb26">${</span><span style="color:#fe8019">this</span>.id<span style="color:#b8bb26">}</span><span style="color:#b8bb26">/`</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">this</span>.headers <span style="color:#fe8019">=</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#b8bb26">&#39;User-Agent&#39;</span><span style="color:#fe8019">:</span> <span style="color:#b8bb26">&#39;curl/7.81.0&#39;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#b8bb26">&#39;accept&#39;</span><span style="color:#fe8019">:</span> <span style="color:#b8bb26">&#34;*/*&#34;</span>,
</span></span><span style="display:flex;"><span>      Referer<span style="color:#fe8019">:</span> <span style="color:#b8bb26">&#39;https://twitter.com/&#39;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#b8bb26">&#39;Content-Type&#39;</span><span style="color:#fe8019">:</span> <span style="color:#b8bb26">&#39;application/json&#39;</span>,
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#fe8019">async</span> init()<span style="color:#fe8019">:</span> Promise&lt;<span style="color:#fb4934">Downloader</span>&gt; {
</span></span><span style="display:flex;"><span>    print.info(<span style="color:#b8bb26">&#34;Starting authentication flow&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">await</span> <span style="color:#fe8019">this</span>.login();
</span></span><span style="display:flex;"><span>    print.info(<span style="color:#b8bb26">`Retrieving space metadata: [</span><span style="color:#b8bb26">${</span><span style="color:#fe8019">this</span>.id<span style="color:#b8bb26">}</span><span style="color:#b8bb26">]`</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">await</span> <span style="color:#fe8019">this</span>.setSpaceMetadataAndMediaKey();
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">const</span> playListInfoResponse: <span style="color:#fabd2f">AxiosResponse</span> <span style="color:#fe8019">=</span> <span style="color:#fe8019">await</span> getRequest(CONSTANTS.PLAYLIST_INFO_URL(<span style="color:#fe8019">this</span>.mediaKey), <span style="color:#fe8019">this</span>.headers);
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">this</span>.playlistUrl <span style="color:#fe8019">=</span> playListInfoResponse.data.source.location;
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">this</span>.chunkBaseUrl <span style="color:#fe8019">=</span> <span style="color:#fe8019">this</span>.playlistUrl.replace(path.basename(<span style="color:#fe8019">this</span>.playlistUrl), <span style="color:#b8bb26">&#39;&#39;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">return</span> <span style="color:#fe8019">this</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#fe8019">private</span> <span style="color:#fe8019">async</span> saveToDisk(data: <span style="color:#fabd2f">any</span>, location: <span style="color:#fabd2f">string</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">await</span> fs.outputFile(path.join(<span style="color:#fe8019">this</span>.storagePath <span style="color:#fe8019">+</span> <span style="color:#b8bb26">&#39;/&#39;</span> <span style="color:#fe8019">+</span> location), data);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#fe8019">async</span> cleanup() {
</span></span><span style="display:flex;"><span>    print.info(<span style="color:#b8bb26">&#34;Cleaning up!&#34;</span>);
</span></span><span style="display:flex;"><span>    print.success(<span style="color:#b8bb26">&#34;Done!&#34;</span>);
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre><p>The <code>init</code> method is where the login happens, alongside other things like setting the media key and the M3U8 playlist URL.</p>
<p>Twitter has this (weird?) login system, where logging in involves completing a series of subtasks. Each subtask returns a <code>flow_token</code> that must be provided when starting the next subtask.</p>
<p>To automate the login system, a guest token is required. The <code>getGuestToken</code> method scrapes the Twitter login page using Cheerio and retrieves the <code>&lt;script&gt;</code> element that sets the cookie. The guest token (<code>gt=</code>) is then extracted using regular expressions:</p>
<pre tabindex="0" style="color:#ebdbb2;background-color:#282828;"><code><span style="display:flex;"><span>  <span style="color:#fe8019">private</span> <span style="color:#fe8019">async</span> getGuestToken()<span style="color:#fe8019">:</span> Promise&lt;<span style="color:#fb4934">string</span>&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">let</span> scriptText <span style="color:#fe8019">=</span> <span style="color:#b8bb26">&#39;&#39;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">this</span>.$(<span style="color:#b8bb26">&#39;script&#39;</span>).each((_: <span style="color:#fabd2f">number</span>, element: <span style="color:#fabd2f">cheerio.Element</span>) <span style="color:#fe8019">=&gt;</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#fe8019">let</span> text <span style="color:#fe8019">=</span> <span style="color:#fe8019">this</span>.$(element).html();
</span></span><span style="display:flex;"><span>      <span style="color:#fe8019">if</span> (text <span style="color:#fe8019">&amp;&amp;</span> text.includes(<span style="color:#b8bb26">&#39;document.cookie&#39;</span>)) {
</span></span><span style="display:flex;"><span>        scriptText <span style="color:#fe8019">=</span> text;
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span> <span style="color:#fe8019">false</span>; <span style="color:#928374;font-style:italic">// Break the loop
</span></span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic"></span>      }
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">const</span> stringWithGT: <span style="color:#fabd2f">RegExpMatchArray</span> <span style="color:#fe8019">|</span> <span style="color:#fe8019">null</span> <span style="color:#fe8019">=</span> scriptText.match(<span style="color:#b8bb26">/&#34;gt=\d{19}/</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> (stringWithGT <span style="color:#fe8019">&amp;&amp;</span> stringWithGT[<span style="color:#d3869b">0</span>]) <span style="color:#fe8019">return</span> stringWithGT[<span style="color:#d3869b">0</span>].replace(<span style="color:#b8bb26">&#39;&#34;gt=&#39;</span>, <span style="color:#b8bb26">&#39;&#39;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">throw</span> <span style="color:#fe8019">new</span> <span style="color:#fabd2f">Error</span>(<span style="color:#b8bb26">&#39;Failed to get guest token&#39;</span>);
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre><p><code>getGuestToken</code> is used in the <code>login</code> method like so. This code logins into the account by performing these subtasks in the sequence: <code>'' -&gt; LoginJsInstrumentationSubtask -&gt; LoginEnterUserIdentifierSSO -&gt; AccountDuplicationCheck</code>. If the operation is successful, I will get an authentication token and a CSRF token <sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>.</p>
<pre tabindex="0" style="color:#ebdbb2;background-color:#282828;"><code><span style="display:flex;"><span>  <span style="color:#fe8019">async</span> login() {
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">try</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#fe8019">const</span> response: <span style="color:#fabd2f">AxiosResponse</span> <span style="color:#fe8019">=</span> <span style="color:#fe8019">await</span> getRequest(CONSTANTS.URL_BASE, <span style="color:#fe8019">this</span>.headers);
</span></span><span style="display:flex;"><span>      <span style="color:#fe8019">this</span>.$ <span style="color:#fe8019">=</span> cheerio.load(response.data);
</span></span><span style="display:flex;"><span>      print.info(<span style="color:#b8bb26">&#34;Retrieving guest token...&#34;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#fe8019">this</span>.headers[<span style="color:#b8bb26">&#39;X-Guest-Token&#39;</span>] <span style="color:#fe8019">=</span> <span style="color:#fe8019">await</span> <span style="color:#fe8019">this</span>.getGuestToken();
</span></span><span style="display:flex;"><span>      <span style="color:#fe8019">this</span>.headers[<span style="color:#b8bb26">&#34;Authorization&#34;</span>] <span style="color:#fe8019">=</span> CONSTANTS.BEARER;
</span></span><span style="display:flex;"><span>      <span style="color:#928374;font-style:italic">// Initialize login flow:
</span></span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic"></span>      print.info(<span style="color:#b8bb26">&#39;Logging in with credentials. Make sure 2FA is disabled on your account&#39;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#fe8019">let</span> taskResponse: <span style="color:#fabd2f">any</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#fe8019">let</span> taskInputs: <span style="color:#fabd2f">any</span> <span style="color:#fe8019">=</span> CONSTANTS.LOGIN_FLOW_SUBTASK_DATA[<span style="color:#b8bb26">&#39;&#39;</span>].input;
</span></span><span style="display:flex;"><span>      taskResponse <span style="color:#fe8019">=</span> (<span style="color:#fe8019">await</span> postRequest(CONSTANTS.URL_FLOW_1, <span style="color:#fe8019">this</span>.headers, JSON.stringify(taskInputs)));
</span></span><span style="display:flex;"><span>      <span style="color:#fe8019">let</span> flowToken: <span style="color:#fabd2f">string</span> <span style="color:#fe8019">=</span> taskResponse.data.flow_token;
</span></span><span style="display:flex;"><span>      <span style="color:#928374;font-style:italic">// console.log(taskResponse.data)
</span></span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic"></span>      <span style="color:#fe8019">let</span> nextSubtask: <span style="color:#fabd2f">string</span> <span style="color:#fe8019">=</span> taskResponse.data.subtasks[<span style="color:#d3869b">0</span>].subtask_id;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#fe8019">const</span> att: <span style="color:#fabd2f">string</span> <span style="color:#fe8019">=</span> taskResponse.headers
</span></span><span style="display:flex;"><span>        .<span style="color:#fe8019">get</span>(<span style="color:#b8bb26">&#39;set-cookie&#39;</span>)
</span></span><span style="display:flex;"><span>        .find((x: <span style="color:#fabd2f">string</span>) <span style="color:#fe8019">=&gt;</span> x.startsWith(<span style="color:#b8bb26">&#39;att=&#39;</span>))
</span></span><span style="display:flex;"><span>        .split(<span style="color:#b8bb26">&#39;att=&#39;</span>)[<span style="color:#d3869b">1</span>]
</span></span><span style="display:flex;"><span>        .split(<span style="color:#b8bb26">&#39;;&#39;</span>)[<span style="color:#d3869b">0</span>];
</span></span><span style="display:flex;"><span>      <span style="color:#fe8019">this</span>.setHeaders({ cookie<span style="color:#fe8019">:</span> <span style="color:#b8bb26">`att=</span><span style="color:#b8bb26">${</span>att<span style="color:#b8bb26">}</span><span style="color:#b8bb26">`</span> });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#fe8019">while</span> (<span style="color:#fe8019">!</span><span style="color:#fe8019">this</span>.isLoggedIn) {
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">if</span> (<span style="color:#fabd2f">Object</span>.keys(CONSTANTS.LOGIN_FLOW_SUBTASK_DATA).find(x <span style="color:#fe8019">=&gt;</span> x <span style="color:#fe8019">===</span> nextSubtask)) {
</span></span><span style="display:flex;"><span>          print.info(<span style="color:#b8bb26">`Performing next subtask: </span><span style="color:#b8bb26">${</span>nextSubtask<span style="color:#b8bb26">}</span><span style="color:#b8bb26">`</span>);
</span></span><span style="display:flex;"><span>        } <span style="color:#fe8019">else</span> {
</span></span><span style="display:flex;"><span>          <span style="color:#fe8019">throw</span> <span style="color:#fe8019">new</span> <span style="color:#fabd2f">Error</span>(<span style="color:#b8bb26">&#34;Failed to get next subtask&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">if</span> (nextSubtask <span style="color:#fe8019">===</span> <span style="color:#b8bb26">&#39;LoginJsInstrumentationSubtask&#39;</span>) {
</span></span><span style="display:flex;"><span>          taskInputs <span style="color:#fe8019">=</span> { flow_token: <span style="color:#fabd2f">flowToken</span>, ...CONSTANTS.LOGIN_FLOW_SUBTASK_DATA[nextSubtask].input };
</span></span><span style="display:flex;"><span>          taskResponse <span style="color:#fe8019">=</span> <span style="color:#fe8019">await</span> postRequest(CONSTANTS.URL_FLOW_2, <span style="color:#fe8019">this</span>.headers, JSON.stringify(taskInputs));
</span></span><span style="display:flex;"><span>          flowToken <span style="color:#fe8019">=</span> taskResponse.data.flow_token;
</span></span><span style="display:flex;"><span>          nextSubtask <span style="color:#fe8019">=</span> taskResponse.data.subtasks[<span style="color:#d3869b">0</span>].subtask_id;
</span></span><span style="display:flex;"><span>        } <span style="color:#fe8019">else</span> <span style="color:#fe8019">if</span> (nextSubtask <span style="color:#fe8019">===</span> <span style="color:#b8bb26">&#39;LoginEnterUserIdentifierSSO&#39;</span>) {
</span></span><span style="display:flex;"><span>          print.<span style="color:#fe8019">default</span>(<span style="color:#b8bb26">&#39;Submitting username...&#39;</span>);
</span></span><span style="display:flex;"><span>          taskInputs <span style="color:#fe8019">=</span> { flow_token: <span style="color:#fabd2f">flowToken</span>, ...CONSTANTS.LOGIN_FLOW_SUBTASK_DATA[nextSubtask](<span style="color:#fe8019">this</span>.username).input }
</span></span><span style="display:flex;"><span>          taskResponse <span style="color:#fe8019">=</span> <span style="color:#fe8019">await</span> postRequest(CONSTANTS.URL_FLOW_2, <span style="color:#fe8019">this</span>.headers, JSON.stringify(taskInputs));
</span></span><span style="display:flex;"><span>          flowToken <span style="color:#fe8019">=</span> taskResponse.data.flow_token;
</span></span><span style="display:flex;"><span>          <span style="color:#928374;font-style:italic">// console.log(taskResponse.data)
</span></span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic"></span>          nextSubtask <span style="color:#fe8019">=</span> taskResponse.data.subtasks[<span style="color:#d3869b">0</span>].subtask_id;
</span></span><span style="display:flex;"><span>        } <span style="color:#fe8019">else</span> <span style="color:#fe8019">if</span> (nextSubtask <span style="color:#fe8019">===</span> <span style="color:#b8bb26">&#39;LoginEnterPassword&#39;</span>) {
</span></span><span style="display:flex;"><span>          print.<span style="color:#fe8019">default</span>(<span style="color:#b8bb26">&#39;Submitting password...&#39;</span>);
</span></span><span style="display:flex;"><span>          taskInputs <span style="color:#fe8019">=</span> { flow_token: <span style="color:#fabd2f">flowToken</span>, ...CONSTANTS.LOGIN_FLOW_SUBTASK_DATA[nextSubtask](<span style="color:#fe8019">this</span>.password).input }
</span></span><span style="display:flex;"><span>          taskResponse <span style="color:#fe8019">=</span> <span style="color:#fe8019">await</span> postRequest(CONSTANTS.URL_FLOW_2, <span style="color:#fe8019">this</span>.headers, JSON.stringify(taskInputs));
</span></span><span style="display:flex;"><span>          flowToken <span style="color:#fe8019">=</span> taskResponse.data.flow_token;
</span></span><span style="display:flex;"><span>          nextSubtask <span style="color:#fe8019">=</span> taskResponse.data.subtasks[<span style="color:#d3869b">0</span>].subtask_id;
</span></span><span style="display:flex;"><span>        } <span style="color:#fe8019">else</span> <span style="color:#fe8019">if</span> (nextSubtask <span style="color:#fe8019">===</span> <span style="color:#b8bb26">&#39;AccountDuplicationCheck&#39;</span>) {
</span></span><span style="display:flex;"><span>          print.info(<span style="color:#b8bb26">&#39;Performing account duplication check&#39;</span>)
</span></span><span style="display:flex;"><span>          taskInputs <span style="color:#fe8019">=</span> { flow_token: <span style="color:#fabd2f">flowToken</span>, ...CONSTANTS.LOGIN_FLOW_SUBTASK_DATA[nextSubtask].input };
</span></span><span style="display:flex;"><span>          taskResponse <span style="color:#fe8019">=</span> <span style="color:#fe8019">await</span> postRequest(CONSTANTS.URL_FLOW_2, <span style="color:#fe8019">this</span>.headers, JSON.stringify(taskInputs));
</span></span><span style="display:flex;"><span>          flowToken <span style="color:#fe8019">=</span> taskResponse.data.flow_token;
</span></span><span style="display:flex;"><span>          nextSubtask <span style="color:#fe8019">=</span> taskResponse.data.subtasks[<span style="color:#d3869b">0</span>].subtask_id;
</span></span><span style="display:flex;"><span>          <span style="color:#fe8019">this</span>.isLoggedIn <span style="color:#fe8019">=</span> <span style="color:#fe8019">true</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      print.info(<span style="color:#b8bb26">&#34;Getting Authentication Token...&#34;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#fe8019">const</span> twitterAuthToken <span style="color:#fe8019">=</span> taskResponse.headers.<span style="color:#fe8019">get</span>(<span style="color:#b8bb26">&#39;set-cookie&#39;</span>)
</span></span><span style="display:flex;"><span>        .find((x: <span style="color:#fabd2f">string</span>) <span style="color:#fe8019">=&gt;</span> x.startsWith(<span style="color:#b8bb26">&#39;auth_token=&#39;</span>))
</span></span><span style="display:flex;"><span>        .split(<span style="color:#b8bb26">&#39;auth_token=&#39;</span>)[<span style="color:#d3869b">1</span>]
</span></span><span style="display:flex;"><span>        .split(<span style="color:#b8bb26">&#39;;&#39;</span>)[<span style="color:#d3869b">0</span>];
</span></span><span style="display:flex;"><span>      print.info(<span style="color:#b8bb26">&#34;Getting CSRF Token...&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#fe8019">let</span> csrfToken <span style="color:#fe8019">=</span> taskResponse.headers
</span></span><span style="display:flex;"><span>        .<span style="color:#fe8019">get</span>(<span style="color:#b8bb26">&#39;set-cookie&#39;</span>)
</span></span><span style="display:flex;"><span>        .find((x: <span style="color:#fabd2f">string</span>) <span style="color:#fe8019">=&gt;</span> x.startsWith(<span style="color:#b8bb26">&#39;ct0=&#39;</span>))
</span></span><span style="display:flex;"><span>        .split(<span style="color:#b8bb26">&#39;ct0=&#39;</span>)[<span style="color:#d3869b">1</span>]
</span></span><span style="display:flex;"><span>        .split(<span style="color:#b8bb26">&#39;;&#39;</span>)[<span style="color:#d3869b">0</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#fe8019">this</span>.setHeaders({ cookie<span style="color:#fe8019">:</span> <span style="color:#b8bb26">`</span><span style="color:#b8bb26">${</span><span style="color:#fe8019">this</span>.headers.cookie<span style="color:#b8bb26">}</span><span style="color:#b8bb26">; auth_token=</span><span style="color:#b8bb26">${</span>twitterAuthToken<span style="color:#b8bb26">}</span><span style="color:#b8bb26">; ct0=</span><span style="color:#b8bb26">${</span>csrfToken<span style="color:#b8bb26">}</span><span style="color:#b8bb26">`</span>, <span style="color:#b8bb26">&#39;X-Csrf-Token&#39;</span><span style="color:#fe8019">:</span> csrfToken });
</span></span><span style="display:flex;"><span>      print.success(<span style="color:#b8bb26">&#34;Login Success!\n\n&#34;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#928374;font-style:italic">// console.log(this.headers);
</span></span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic"></span>    } <span style="color:#fe8019">catch</span> (error) {
</span></span><span style="display:flex;"><span>      <span style="color:#fe8019">throw</span> error;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">this</span>.isLoggedIn <span style="color:#fe8019">=</span> <span style="color:#fe8019">true</span>;
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre><p>If nothing goes wrong, the <code>generateAudio</code> method is invoked.</p>
<pre tabindex="0" style="color:#ebdbb2;background-color:#282828;"><code><span style="display:flex;"><span>  <span style="color:#fe8019">async</span> generateAudio() {
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">this</span>.playlist <span style="color:#fe8019">=</span> <span style="color:#fe8019">await</span> <span style="color:#fe8019">this</span>.getPlaylist();
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">this</span>.chunksUrls <span style="color:#fe8019">=</span> <span style="color:#fe8019">this</span>.parsePlaylist();
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">await</span> <span style="color:#fe8019">this</span>.downloadSegments(<span style="color:#fe8019">this</span>.chunksUrls);
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">await</span> <span style="color:#fe8019">this</span>.convertSegmentsToMp3();
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">this</span>.audioGenerated <span style="color:#fe8019">=</span> <span style="color:#fe8019">true</span>;
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre><p>In this method, I call <code>getPlaylist</code> to retrieve the playlist and store it to prevent unnecessary network calls <sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup>.</p>
<pre tabindex="0" style="color:#ebdbb2;background-color:#282828;"><code><span style="display:flex;"><span> <span style="color:#fe8019">private</span> <span style="color:#fe8019">async</span> getPlaylist() {
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">let</span> playlistPath: <span style="color:#fabd2f">string</span> <span style="color:#fe8019">=</span> path.join(<span style="color:#fe8019">this</span>.storagePath <span style="color:#fe8019">+</span> <span style="color:#b8bb26">&#34;/&#34;</span> <span style="color:#fe8019">+</span> <span style="color:#b8bb26">&#34;playlist.m3u8&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">let</span> playlist: <span style="color:#fabd2f">string</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> (<span style="color:#fe8019">await</span> fs.pathExists(playlistPath)) {
</span></span><span style="display:flex;"><span>      print.info(<span style="color:#b8bb26">&#39;Playlist already downloaded!&#39;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#fe8019">return</span> <span style="color:#fe8019">await</span> fs.readFile(playlistPath, { encoding<span style="color:#fe8019">:</span> <span style="color:#b8bb26">&#34;utf-8&#34;</span> });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print.info(<span style="color:#b8bb26">&#39;Downloading playlist&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    playlist <span style="color:#fe8019">=</span> (<span style="color:#fe8019">await</span> getRequest(<span style="color:#fe8019">this</span>.playlistUrl, <span style="color:#fe8019">this</span>.headers)).data;
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">await</span> <span style="color:#fe8019">this</span>.saveToDisk(playlist, <span style="color:#b8bb26">`playlist.m3u8`</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">return</span> playlist;
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre><p>Next, the downloaded playlist is parsed with the <a href="https://www.npmjs.com/package/m3u8-parser">m3u8-parser package</a>.</p>
<pre tabindex="0" style="color:#ebdbb2;background-color:#282828;"><code><span style="display:flex;"><span>  <span style="color:#fe8019">private</span> parsePlaylist()<span style="color:#fe8019">:</span> <span style="color:#fabd2f">string</span>[] {
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">const</span> parser <span style="color:#fe8019">=</span> <span style="color:#fe8019">new</span> m3u8Parser.Parser();
</span></span><span style="display:flex;"><span>    parser.push(<span style="color:#fe8019">this</span>.playlist);
</span></span><span style="display:flex;"><span>    parser.end();
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">this</span>.playlistManifest <span style="color:#fe8019">=</span> parser.manifest;
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">return</span> parser.manifest.segments.map((x<span style="color:#fe8019">:</span> { uri: <span style="color:#fabd2f">string</span> }) <span style="color:#fe8019">=&gt;</span> <span style="color:#fe8019">this</span>.chunkBaseUrl <span style="color:#fe8019">+</span> x.uri);
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre><p>This makes it easier to retrieve the URL for each audio chunk. Next, each chunk URL is fed into <code>downloadSegments</code> where they are downloaded to the disk.</p>
<pre tabindex="0" style="color:#ebdbb2;background-color:#282828;"><code><span style="display:flex;"><span>  <span style="color:#fe8019">private</span> <span style="color:#fe8019">async</span> downloadSegments(
</span></span><span style="display:flex;"><span>    chunks: <span style="color:#fabd2f">string</span>[],
</span></span><span style="display:flex;"><span>    retryCount: <span style="color:#fabd2f">Record</span>&lt;<span style="color:#fb4934">string</span>, <span style="color:#b8bb26;font-weight:bold">number</span>&gt; <span style="color:#fe8019">=</span> {},
</span></span><span style="display:flex;"><span>    maxRetries: <span style="color:#fabd2f">number</span> <span style="color:#fe8019">=</span> <span style="color:#d3869b">10</span>
</span></span><span style="display:flex;"><span>  )<span style="color:#fe8019">:</span> Promise&lt;<span style="color:#fb4934">void</span>&gt; {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// Check cache for the downloaded chunks
</span></span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic"></span>
</span></span><span style="display:flex;"><span>    print.info(<span style="color:#b8bb26">&#39;Starting to download audio chunks&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">for</span> (<span style="color:#fe8019">let</span> url <span style="color:#fe8019">of</span> chunks) {
</span></span><span style="display:flex;"><span>      <span style="color:#fe8019">let</span> message <span style="color:#fe8019">=</span> <span style="color:#b8bb26">`Starting to download chunks`</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#fe8019">const</span> chunkName <span style="color:#fe8019">=</span> path.basename(url);
</span></span><span style="display:flex;"><span>      <span style="color:#fe8019">const</span> chunkStorageLocation: <span style="color:#fabd2f">string</span> <span style="color:#fe8019">=</span> path.join(<span style="color:#b8bb26">&#39;chunks&#39;</span>, chunkName);
</span></span><span style="display:flex;"><span>      <span style="color:#fe8019">if</span> (<span style="color:#fe8019">!</span>retryCount[chunkName]) retryCount[chunkName] <span style="color:#fe8019">=</span> <span style="color:#d3869b">0</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#fe8019">if</span> (<span style="color:#fe8019">await</span> fs.pathExists(path.resolve(<span style="color:#fe8019">this</span>.storagePath <span style="color:#fe8019">+</span> <span style="color:#b8bb26">&#34;/&#34;</span> <span style="color:#fe8019">+</span> chunkStorageLocation))) {
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">this</span>.downloadChunksCount<span style="color:#fe8019">++</span>;
</span></span><span style="display:flex;"><span>        message <span style="color:#fe8019">=</span> <span style="color:#b8bb26">`Skipping </span><span style="color:#b8bb26">${</span>chunkName<span style="color:#b8bb26">}</span><span style="color:#b8bb26">`</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// print.info(`${urlPath} already downloaded! Skipped!`);
</span></span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic"></span>        <span style="color:#928374;font-style:italic">// break;
</span></span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic"></span>      } <span style="color:#fe8019">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">try</span> {
</span></span><span style="display:flex;"><span>          message <span style="color:#fe8019">=</span> <span style="color:#b8bb26">`Downloading </span><span style="color:#b8bb26">${</span>chunkName<span style="color:#b8bb26">}</span><span style="color:#b8bb26">`</span>
</span></span><span style="display:flex;"><span>          <span style="color:#fe8019">const</span> response <span style="color:#fe8019">=</span> Buffer.<span style="color:#fe8019">from</span>((<span style="color:#fe8019">await</span> axios.<span style="color:#fe8019">get</span>(url, { responseType<span style="color:#fe8019">:</span> <span style="color:#b8bb26">&#39;arraybuffer&#39;</span> })).data);
</span></span><span style="display:flex;"><span>          <span style="color:#fe8019">this</span>.downloadChunksCount<span style="color:#fe8019">++</span>;
</span></span><span style="display:flex;"><span>          <span style="color:#928374;font-style:italic">// console.log(`Downloaded ${urlPath} ........................................ ${((this.downloadChunksCount / this.chunksUrls.length) * 100).toFixed(2)}% done`);
</span></span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic"></span>          <span style="color:#fe8019">await</span> <span style="color:#fe8019">this</span>.saveToDisk(response, chunkStorageLocation);
</span></span><span style="display:flex;"><span>          <span style="color:#928374;font-style:italic">// return response;
</span></span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic"></span>        } <span style="color:#fe8019">catch</span> (error: <span style="color:#fabd2f">any</span>) {
</span></span><span style="display:flex;"><span>          <span style="color:#fe8019">if</span> (retryCount[chunkName] <span style="color:#fe8019">&gt;=</span> maxRetries) {
</span></span><span style="display:flex;"><span>            <span style="color:#fe8019">throw</span> <span style="color:#fe8019">new</span> <span style="color:#fabd2f">Error</span>(<span style="color:#b8bb26">`</span>\<span style="color:#b8bb26">nFailed to fetch chunk: </span><span style="color:#b8bb26">${</span>chunkName<span style="color:#b8bb26">}</span><span style="color:#b8bb26">. Giving up after </span><span style="color:#b8bb26">${</span>maxRetries<span style="color:#b8bb26">}</span><span style="color:#b8bb26"> retries. </span>\<span style="color:#b8bb26">n</span><span style="color:#b8bb26">${</span>error.message<span style="color:#b8bb26">}</span><span style="color:#b8bb26">`</span>);
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>          retryCount[chunkName] <span style="color:#fe8019">+=</span> <span style="color:#d3869b">1</span>;
</span></span><span style="display:flex;"><span>          console.error(<span style="color:#b8bb26">`Failed to fetch </span><span style="color:#b8bb26">${</span>chunkName<span style="color:#b8bb26">}</span><span style="color:#b8bb26"> .................................. Retrying [</span><span style="color:#b8bb26">${</span>retryCount[chunkName]<span style="color:#b8bb26">}</span><span style="color:#b8bb26">/</span><span style="color:#b8bb26">${</span>maxRetries<span style="color:#b8bb26">}</span><span style="color:#b8bb26">]`</span>);
</span></span><span style="display:flex;"><span>          <span style="color:#fe8019">return</span> <span style="color:#fe8019">this</span>.downloadSegments([url], retryCount, maxRetries);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      print.progress(<span style="color:#fe8019">this</span>.downloadChunksCount, <span style="color:#fe8019">this</span>.chunksUrls.length, message, <span style="color:#b8bb26">&#34;AUDIO&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre><p>Finally, <code>convertSegmentsToMp3</code> converts each chunk to the <code>.mp3</code> audio format and combines them. <code>convertSegmentsToMp3</code> uses the <a href="https://www.npmjs.com/package/fluent-ffmpeg">fluent-ffmpeg</a> Node.js FFmpeg wrapper to work with the audio files. This means that FFmpeg must be installed on your machine for it to work properly.</p>
<p>I read each downloaded chunk and wrote it into the PassThrough Duplex stream. With this, fluent-ffmpeg can read the stream change the format from <code>.aac</code> to <code>.mp3</code>, setting the audio codec as <code>libmp3lame</code> with a 44.1Khz sample rate frequency.</p>
<pre tabindex="0" style="color:#ebdbb2;background-color:#282828;"><code><span style="display:flex;"><span>  <span style="color:#fe8019">private</span> <span style="color:#fe8019">async</span> convertSegmentsToMp3() {
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">await</span> fs.ensureDir(path.join(<span style="color:#fe8019">this</span>.storagePath, <span style="color:#b8bb26">&#39;out/&#39;</span>));
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">const</span> passThroughStream <span style="color:#fe8019">=</span> <span style="color:#fe8019">new</span> PassThrough();
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">const</span> finalOutputFilePath <span style="color:#fe8019">=</span> path.join(<span style="color:#fe8019">this</span>.storagePath, <span style="color:#b8bb26">&#39;out/&#39;</span>, <span style="color:#b8bb26">`</span><span style="color:#b8bb26">${</span><span style="color:#fe8019">this</span>.audioSpaceData.metadata.title<span style="color:#b8bb26">}</span><span style="color:#b8bb26">.mp3`</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// const ffmpegCommand = ffmpeg();
</span></span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic"></span>    <span style="color:#fe8019">const</span> chunks: <span style="color:#fabd2f">string</span>[] <span style="color:#fe8019">=</span> <span style="color:#fe8019">await</span> fs.readdir(path.join(<span style="color:#fe8019">this</span>.storagePath, <span style="color:#b8bb26">&#39;chunks&#39;</span>), { encoding<span style="color:#fe8019">:</span> <span style="color:#b8bb26">&#34;utf-8&#34;</span> });
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> (chunks.length <span style="color:#fe8019">===</span> <span style="color:#d3869b">0</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#fe8019">throw</span> <span style="color:#fe8019">new</span> <span style="color:#fabd2f">Error</span>(<span style="color:#b8bb26">&#39;Failed to fetch chunks saved on disk.&#39;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">for</span> (<span style="color:#fe8019">const</span> chunkPath <span style="color:#fe8019">of</span> chunks) {
</span></span><span style="display:flex;"><span>      passThroughStream.write(<span style="color:#fe8019">await</span> fs.readFile(path.join(<span style="color:#fe8019">this</span>.storagePath, <span style="color:#b8bb26">&#39;chunks/&#39;</span>, chunkPath)));
</span></span><span style="display:flex;"><span>      <span style="color:#928374;font-style:italic">// ffmpegCommand.input(path.join(this.storagePath, &#39;chunks/&#39;, chunkPath))
</span></span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic"></span>    };
</span></span><span style="display:flex;"><span>    passThroughStream.end();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">await</span> <span style="color:#fe8019">new</span> Promise&lt;<span style="color:#fb4934">void</span>&gt;((resolve, reject) <span style="color:#fe8019">=&gt;</span> {
</span></span><span style="display:flex;"><span>      ffmpeg(passThroughStream)
</span></span><span style="display:flex;"><span>        .inputFormat(<span style="color:#b8bb26">&#39;aac&#39;</span>)
</span></span><span style="display:flex;"><span>        .audioFrequency(<span style="color:#d3869b">44100</span>)  <span style="color:#928374;font-style:italic">// Set sample rate to 44.1 kHz for better quality
</span></span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic"></span>        .audioChannels(<span style="color:#d3869b">2</span>)       <span style="color:#928374;font-style:italic">// Set audio channels to stereo
</span></span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic"></span>        .audioCodec(<span style="color:#b8bb26">&#39;libmp3lame&#39;</span>) <span style="color:#928374;font-style:italic">// Set audio codec to libmp3lame for MP3 encoding
</span></span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic"></span>        .toFormat(<span style="color:#b8bb26">&#39;mp3&#39;</span>)        <span style="color:#928374;font-style:italic">// Set output format to mp3
</span></span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic"></span>        .on(<span style="color:#b8bb26">&#39;error&#39;</span>, (err) <span style="color:#fe8019">=&gt;</span> {
</span></span><span style="display:flex;"><span>          reject(<span style="color:#b8bb26">`Error: </span><span style="color:#b8bb26">${</span>err.message<span style="color:#b8bb26">}</span><span style="color:#b8bb26">`</span>);
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>        .on(<span style="color:#b8bb26">&#39;progress&#39;</span>, (progress) <span style="color:#fe8019">=&gt;</span> {
</span></span><span style="display:flex;"><span>          <span style="color:#fe8019">const</span> duration: <span style="color:#fabd2f">number</span> <span style="color:#fe8019">=</span> <span style="color:#fe8019">new</span> <span style="color:#fabd2f">Date</span>(<span style="color:#fabd2f">Number</span>(<span style="color:#fe8019">this</span>.audioSpaceData.metadata.ended_at) <span style="color:#fe8019">-</span> <span style="color:#fe8019">this</span>.audioSpaceData.metadata.started_at).getTime();
</span></span><span style="display:flex;"><span>          <span style="color:#fe8019">const</span> datedTimeStamp: <span style="color:#fabd2f">number</span> <span style="color:#fe8019">=</span> <span style="color:#fe8019">new</span> <span style="color:#fabd2f">Date</span>(<span style="color:#b8bb26">`1970-01-01T</span><span style="color:#b8bb26">${</span>progress.timemark<span style="color:#b8bb26">}</span><span style="color:#b8bb26">Z`</span>).getTime();
</span></span><span style="display:flex;"><span>          print.progress(datedTimeStamp, duration, <span style="color:#b8bb26">&#34;Combining chunks and converting to .mp3&#34;</span>, <span style="color:#b8bb26">&#34;FFMPEG&#34;</span>);
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>        .on(<span style="color:#b8bb26">&#39;end&#39;</span>, () <span style="color:#fe8019">=&gt;</span> {
</span></span><span style="display:flex;"><span>          resolve();
</span></span><span style="display:flex;"><span>          print.success(<span style="color:#b8bb26">&#39;Merging completed&#39;</span>);
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>        .save(finalOutputFilePath);
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre><p>With the <code>Downloader</code> class set up, all that's left is to create a CLI that will instantiate the class. This CLI uses the <a href="https://www.npmjs.com/commander">Commander</a> package, although I feel it is a bit overkill for such a small project. But I am keeping it anyways.</p>
<pre tabindex="0" style="color:#ebdbb2;background-color:#282828;"><code><span style="display:flex;"><span><span style="color:#fe8019">import</span> { Command } <span style="color:#fe8019">from</span> <span style="color:#b8bb26">&#39;commander&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#fe8019">import</span> { Downloader } <span style="color:#fe8019">from</span> <span style="color:#b8bb26">&#39;../index.js&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#fe8019">import</span> { DownloaderOptions } <span style="color:#fe8019">from</span> <span style="color:#b8bb26">&#39;../types.js&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#fe8019">const</span> program <span style="color:#fe8019">=</span> <span style="color:#fe8019">new</span> Command();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>program
</span></span><span style="display:flex;"><span>    .name(<span style="color:#b8bb26">&#39;spaces-dl&#39;</span>)
</span></span><span style="display:flex;"><span>    .description(<span style="color:#b8bb26">&#39;CLI to download recorded Twitter Spaces&#39;</span>)
</span></span><span style="display:flex;"><span>    .version(<span style="color:#b8bb26">&#39;0.0.1&#39;</span>)
</span></span><span style="display:flex;"><span>    .option(<span style="color:#b8bb26">&#39;-m, --m3u8&#39;</span>, <span style="color:#b8bb26">&#39;m3u8 file url&#39;</span>)
</span></span><span style="display:flex;"><span>    .option(<span style="color:#b8bb26">&#39;-i, --id &lt;id&gt;&#39;</span>, <span style="color:#b8bb26">&#39;A valid ID for a recorded Twitter Space&#39;</span>)
</span></span><span style="display:flex;"><span>    .option(<span style="color:#b8bb26">&#39;-u, --username &lt;username&gt;&#39;</span>, <span style="color:#b8bb26">&#39;a valid twitter username without the @&#39;</span>)
</span></span><span style="display:flex;"><span>    .option(<span style="color:#b8bb26">&#39;-p, --password &lt;password&gt;&#39;</span>, <span style="color:#b8bb26">&#39;a valid password for the username&#39;</span>)
</span></span><span style="display:flex;"><span>    .option(<span style="color:#b8bb26">&#39;-o, --output &lt;path&gt;&#39;</span>, <span style="color:#b8bb26">&#39;output path for the recorded audio/video&#39;</span>)
</span></span><span style="display:flex;"><span>    .action((options) <span style="color:#fe8019">=&gt;</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">if</span> (<span style="color:#fe8019">!</span>options.id <span style="color:#fe8019">&amp;&amp;</span> <span style="color:#fe8019">!</span>options.m3u8) {
</span></span><span style="display:flex;"><span>            console.error(<span style="color:#b8bb26">&#34;Error: --id option required&#34;</span>);
</span></span><span style="display:flex;"><span>            process.exit(<span style="color:#d3869b">1</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>program.parse(process.argv);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fe8019">const</span> options: <span style="color:#fabd2f">DownloaderOptions</span> <span style="color:#fe8019">=</span> program.opts();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fe8019">try</span> {
</span></span><span style="display:flex;"><span>    console.log(options);
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">let</span> task: <span style="color:#fabd2f">Downloader</span>;
</span></span><span style="display:flex;"><span>    task <span style="color:#fe8019">=</span> <span style="color:#fe8019">await</span> <span style="color:#fe8019">new</span> Downloader(options).init();
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">await</span> task.generateAudio();
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">await</span> task.cleanup();
</span></span><span style="display:flex;"><span>} <span style="color:#fe8019">catch</span> (error) {
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">throw</span> error;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>When the code is transpiled. In my terminal, I can run the following from the project root:</p>
<pre tabindex="0" style="color:#ebdbb2;background-color:#282828;"><code><span style="display:flex;"><span>node dist/cli/cli.js --username &lt;username&gt; --password &lt;password&gt; -i &lt;twitter_space_id&gt;
</span></span></code></pre><p>The <code>twitter_space_id</code> can be obtained from the URL of the Space. For example, in <a href="https://x.com/i/spaces/1OyKAWgagpqJb">https://x.com/i/spaces/1OyKAWgagpqJb</a>, the ID is 1OyKAWgagpqJb.</p>
<p><img src="https://i.imgur.com/AOx5txi.png" alt=""><em>Agba developer!</em></p>
<h2>Future plans</h2>
<p>In the future, I hope to turn this into a full NPM package that you can install globally by running a command like <code>npm install -g spaces-dl</code>. I also want to implement alternative login systems in case the default login system with username and password fails.</p>
<p>Since this is a side project, there are some 'missing' features, like the fact that you cannot provide a custom path for the output audio. I also want to improve the path system to work on Windows machines. You can find the full source code on <a href="https://github.com/daviduzondu/spaces-dl">GitHub</a>.</p>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p>One limitation of this approach is that sometimes, Twitter suspects that you are a bot, thus breaking the entire subtask flow system. So instead of the next subtask after <code>LoginJsInstrumentationSubtask</code> to be <code>LoginEnterUserIdentifierSSO</code>, I get <code>LoginEnterAlternateIdentifierSubtask</code> or sometimes <code>ArkoseLogin</code>. A potential workaround is providing the authentication token and CSRF token directly through the CLI, but I haven't gotten around to implementing that.&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2">
<p>In cases where the user quits the program mid-operation and starts the operation later, this allows the program to use the stored M3U8 playlist instead of re-downloading it from the server. This storage mechanism also works for the audio chunks as well.&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>

  </div>
  
    
<div class="gh-page">
 <a href="https://github.com/daviduzondu/website/tree/master/www/content/_blog/creating-spaces-dl.md">
  View this page on GitHub
 </a>
</div>

  
</article>
</main>
</body>


</html>